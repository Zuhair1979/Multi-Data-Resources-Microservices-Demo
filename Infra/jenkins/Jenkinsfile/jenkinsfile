pipeline {
  agent {
    docker {
      image 'maven:3.9-eclipse-temurin-17'
      args '-v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    APP_IMAGE = "core-user-service:latest"
    APP_DIR   = "Services/core-user-service"
  }

  options { timestamps() }

  stages {
    stage('Show environment') {
      steps {
        sh '''
          echo "Workspace: $WORKSPACE"
          java -version || true
          mvn -version || true
          command -v docker && docker version || true
        '''
      }
    }

    stage('Build & Test (Maven)') {
      steps {
        dir("${APP_DIR}") {
          sh 'mvn -B -U clean test'
          sh 'mvn -B -DskipTests package'
        }
      }
    }

    stage('Docker Build') {
      steps {
        dir("${APP_DIR}") {
          sh 'docker build -t ${APP_IMAGE} .'
        }
      }
    }
  }

  post {
    always {
      sh 'command -v docker && docker ps || true'
    }
  }
}
